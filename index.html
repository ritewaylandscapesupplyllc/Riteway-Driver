<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Riteway Driver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body {font-family: Arial; padding:20px; text-align:center; background:#f9f9f9;}
    h1 {color:#1a5f1a;}
    input, textarea, button {margin:10px auto; padding:12px; font-size:18px; width:90%; max-width:300px; display:block;}
    button {background:#1a5f1a; color:white; border:none; border-radius:6px;}
    #status, #debug {margin:20px; padding:15px; background:#fff; border:1px solid #ccc; border-radius:5px; font-family: monospace; text-align:left; font-size:14px;}
    #debug {color: #d35400;}
  </style>
</head>
<body>
  <h1>Riteway Driver</h1>
  <p>Fill in â†’ Tap <b>Start Tracking</b></p>

  <input type="text" id="deliveryId" placeholder="Delivery ID (e.g. TEST123)">
  <input type="text" id="address" placeholder="Delivery Address (required)">

  <button onclick="start()">Start Tracking</button>
  <button onclick="stop()">Stop Tracking</button>
  <div id="status">Status: Ready</div>
  <div id="debug">Debug Log:</div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDmyq_bxVHipY5UxZY-28sXUu0-fJvL69I",
      authDomain: "ritewaytracking-3e9d0.firebaseapp.com",
      databaseURL: "https://ritewaytracking-3e9d0-default-rtdb.firebaseio.com",
      projectId: "ritewaytracking-3e9d0",
      storageBucket: "ritewaytracking-3e9d0.firebasestorage.app",
      messagingSenderId: "817275576166",
      appId: "1:817275576166:web:56a92bcaf8f60d52a0b2a7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let interval;
    function log(msg) {
      const debug = document.getElementById('debug');
      debug.innerHTML += '<br>' + new Date().toLocaleTimeString() + ': ' + msg;
      console.log(msg);
    }

    function start() {
      const id = document.getElementById('deliveryId').value.trim().toUpperCase();
      const addr = document.getElementById('address').value.trim();
      if (!id || !addr) { alert('ID and Address required!'); return; }

      log('Starting tracking for ' + id);

      const details = { address: addr };
      db.ref('deliveries/' + id + '/details').set(details)
        .then(() => log('Details saved'))
        .catch(err => log('ERROR saving details: ' + err.message));

      document.getElementById('status').innerText = 'Requesting GPS...';

      interval = setInterval(() => {
        navigator.geolocation.getCurrentPosition(
          pos => {
            const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude, ts: new Date().toISOString() };
            db.ref('deliveries/' + id + '/location').set(loc)
              .then(() => log('GPS sent: ' + loc.lat.toFixed(4) + ', ' + loc.lng.toFixed(4)))
              .catch(err => log('ERROR sending GPS: ' + err.message));
            document.getElementById('status').innerText = 'LIVE: Sending to ' + id;
          },
          err => {
            log('GPS ERROR: ' + err.message);
            document.getElementById('status').innerText = 'GPS Error: ' + err.message;
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      }, 30000);

      // First GPS
      navigator.geolocation.getCurrentPosition(pos => {
        const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude, ts: new Date().toISOString() };
        db.ref('deliveries/' + id + '/location').set(loc)
          .then(() => log('First GPS sent'))
          .catch(err => log('ERROR first GPS: ' + err.message));
      });
    }

    function stop() {
      clearInterval(interval);
      const id = document.getElementById('deliveryId').value.trim().toUpperCase();
      if (id) db.ref('deliveries/' + id).remove();
      document.getElementById('status').innerText = 'Stopped';
      log('Tracking stopped');
    }
  </script>
</body>
</html>
